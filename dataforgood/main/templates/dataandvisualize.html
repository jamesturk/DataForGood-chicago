{% load static %}

<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data & Visualize </title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

</head>
<body>
    <header>
        <nav>
            <div class="logo">Data For Good - Chicago</div>
            <ul class="nav-links">
                <li><a href="{% url 'aboutus' %}">About Us</a></li>
                <li><a href="{% url 'dataandvisualize' %}">Data & Visualize</a></li>
                <li><a href="{% url 'resources' %}">Resource</a></li>
            </ul>
        </nav>
    </header>
    <h2>  Data & Visualize </h2>
    <head>
        <style>
            /* body{
                background:white;
                font-family:arial;
            } */

            h1{
                font-size:40px;
                text-align: center;
                padding: 10px;
            }
            h3{
                margin: 20px 20px 30px;
                font-size:25px;
            }
            h4{
                font-size:18px;
            }
            caption{
                font-size:18px;
                margin: 0px 5px 10px;
                font-weight: bold;
            }

            .table1{
                max-width:2000px;
                margin: 20px 20px 20px;
                border-collapse: collapse;
                border-radius:0px;
                border-spacing:5px;
                background: white;
                padding:10px;
                font-size:1em;
            }
            td, th {
            padding: 1rem;
            }
            .table2{
                max-width:500px;
                margin: 0px 20px 20px;
                border-collapse: collapse;
                border-radius:0px;
                border-spacing:5px;
                background: white;
                padding:10px;
                font-size:1em;
                align-items: center;
                float: left;
            }
            .maintable{
                max-width:700px;
                background: rgb(255, 205, 163);
                margin: 20px 20px 50px;
                padding:10px;
            }
            .subtable{
                background: rgb(248, 213, 153);
                max-width:1250px;
                margin: 20px 20px 50px;
                padding:10px;
                height: 600;
            }

            .query-form{
                display: inline-block;
                max-width:300px;
                margin: 10px 20px 30px;
                border-radius:5px;
                background: lightgrey;
                padding:10px;
                font-size:1em;
            }
            .scrollable-checkbox-list {
                height: 150px;
                overflow-y: scroll;; /* Enables vertical scrolling */
                border: 1px solid #ccc;
                padding: 10px;
                border-radius: 5px;
                background-color: white;
                margin-bottom: 10px;
            }
            .year-select {
                padding: 10px;
                border-radius: 5px;
                background-color: white;
                margin-bottom: 10px;
            }

            input[type=text], select{
                width:100%;
                padding:12px 20px;
                margin:8px 0;
                border:1px solid #ccc;
                border-radius:4px;
                box-sizing:border-box;
                font-size:1em;
            }
            input[type=submit]{
                width:100%;
                background:black;
                color: white;
                padding:5px 10px;
                margin: 10px 0;
                border: none;
                border-radius:4px;
                cursor:pointer;
                font-size:0.9em;
            }
            input[type=submit]:hover{
                background:darkgreen;
                font-size:0.9em;
            }

            details {
            border: 1px solid #767676;
            background: lightgrey;
            border-radius: 3px;
            display: inline-flex;
            flex-direction: column;
            padding: 10px 10px;
            }

            details summary::marker {
            display: none;
            font-size: 0;
            }

            details summary::-webkit-details-marker {
            display: none;
            font-size: 0;
            }

            details summary::after {
            content: "\25BC";
            display: inline-block;
            font-size: 0.6rem;
            height: 1rem;
            line-height: 1rem;
            margin-left: 0.5rem;
            position: relative;
            transition: transform 0.25s;
            }

            details[open] summary {
            margin-bottom: 1rem;
            }

            details[open] summary::after {
            top: -0.15rem;
            transform: rotate(180deg);
            }

            fieldset {
            border: 0;
            padding: 0;
            }

            fieldset legend {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
            }

            ul {
            list-style: none;
            margin: 0;
            padding: 0;
            }

            ul li {
            border-radius: 3px;
            margin: 0;
            padding: 4px 2px;
            }

            ul li:hover {
            background: #eee;
            }

            ul li label {
            display: inline-block;
            width: 8rem;
            }


        </style>
    </head>
    <body>
        <div class="query-form">
            <h4> Search Database </h4>
            <form class="SearchForm" method="GET", enctype="multipart/form-data">
                {% csrf_token %}
                <p>{{ form.geographic_level.label_tag }}{{ form.geographic_level }}</p>
                <div class="scrollable-checkbox-list" id="tract_field">
                    <input type="checkbox" id="select_all_tract" onclick="toggleTractSelection(this)">
                    <label for="select_all_tract">Select All/Remove All</label>
                    {{ form.tract }}
                </div>
                <div class="scrollable-checkbox-list" id="zipcode_field">
                    <input type="checkbox" id="select_all_zipcode" onclick="toggleZipcodeSelection(this)">
                    <label for="select_all_zipcode">Select All/Remove All</label>
                    {{ form.zipcode }}
                </div>
                <div class="scrollable-checkbox-list" id="community_field">{{ form.community }}</div>
                <p>{{ form.category.label_tag }}{{ form.category }}</p>
                <p>{{ form.indicator.label_tag }}</p>
                <div  id="economic_field" style="display:none;">{{ form.economic_indicators }}</div>
                <div id="education_field" style="display:none;">{{ form.education_indicators }}</div>
                <div id="health_field" style="display:none;">{{ form.health_indicators }}</div>
                <div  id="housing_field" style="display:none;">{{ form.housing_indicators }}</div>
                <div  id="population_field" style="display:none;">{{ form.population_indicators }}</div>
                <div>
                    <p>{{ form.year.label_tag }}
                    <input type="checkbox" id="select_all_years" onclick="toggleYearSelection(this)">
                    <label for="select_all_years">Select All/Remove All</label>
                    </p>
                </div>
                <div class="year-select">
                    {% for checkbox in form.year %}
                        <label>{{ checkbox.tag }} {{ checkbox.choice_label }}</label><br>
                    {% endfor %}
                </div>
            <button type="submit"> Submit </button>
            </form>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const geoLevelSelect = document.getElementById('id_geographic_level');
                const tractField = document.getElementById('tract_field');
                const zipcodeField = document.getElementById('zipcode_field');
                const communityField = document.getElementById('community_field');

                const categorySelect = document.getElementById('id_category');
                const economicField = document.getElementById('economic_field');
                const educationField = document.getElementById('education_field');
                const healthField = document.getElementById('health_field');
                const housingField = document.getElementById('housing_field');
                const populationField = document.getElementById('population_field');



                function handleGeoLevelChange() {
                    const selectedValue = geoLevelSelect.value;
                    // Hide all fields initially
                    tractField.style.display = 'none';
                    zipcodeField.style.display = 'none';
                    communityField.style.display = 'none';
                    // Show relevant field based on the selection
                    if (selectedValue === 'Tract') {
                        tractField.style.display = 'block';
                    } else if (selectedValue === 'Zipcode') {
                        zipcodeField.style.display = 'block';
                    } else if (selectedValue == 'Community') {
                        communityField.style.display = 'block';
                    }
                }
                geoLevelSelect.addEventListener('change', handleGeoLevelChange);
                handleGeoLevelChange();

                function handleIndicatorChange() {
                    const selectedValue = categorySelect.value;
                    // Hide all fields initially
                    economicField.style.display = 'none';
                    educationField.style.display = 'none';
                    healthField.style.display = 'none';
                    housingField.style.display = 'none';
                    populationField.style.display = 'none';
                    // Show relevant field based on the selection
                    if (selectedValue === 'Economic') {
                        economicField.style.display = 'block';
                    } else if (selectedValue === 'Education') {
                        educationField.style.display = 'block';
                    } else if (selectedValue === 'Health') {
                        healthField.style.display = 'block';
                    } else if (selectedValue == 'Housing') {
                        housingField.style.display = 'block';
                    } else if (selectedValue == 'Population') {
                        populationField.style.display = 'block';
                    }
                }
                categorySelect.addEventListener('change', handleIndicatorChange);
                handleIndicatorChange();
            });

            // function to select/remove all for years
            function toggleYearSelection(source) {
                checkboxes = document.querySelectorAll('[name="year"]');
                for(var i = 0, n = checkboxes.length; i < n; i++) {
                    checkboxes[i].checked = source.checked;
                }
            };

            // function to select/remove all for tracts
            function toggleTractSelection(source) {
                var checkboxes = document.querySelectorAll('input[name="tract"]');
                for (var i = 0, n = checkboxes.length; i < n; i++) {
                    checkboxes[i].checked = source.checked;
                }
            };

            // function to select/remove all for zipcodes
            function toggleZipcodeSelection(source) {
                var checkboxes = document.querySelectorAll('input[name="zipcode"]');
                for (var i = 0, n = checkboxes.length; i < n; i++) {
                    checkboxes[i].checked = source.checked;
                }
            };
        </script>

        <div class="maintable" id="table">
            <h3>{{ table_title }}</h3>
            <table class="table1" border="1" id="main-table">
                <tr>
                    {% for header in field.headers %}
                        <th>{{ header }}</th>
                    {% endfor %}
                </tr>
                {% for row in field.rows %}
                    <tr>
                        {% for value in row %}
                            <td>{{ value }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
            <div>
                <button onclick="downloadTableAsExcel()">Download as Excel</button>
                <button onclick="downloadTableAsCSV()">Download as CSV</button>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
        <script>
            function downloadTableAsExcel() {
                var table = document.getElementById("main-table");
                var wb = XLSX.utils.table_to_book(table);
                XLSX.writeFile(wb, "main-table.xlsx");
            }

            function downloadTableAsCSV() {
                var table = document.getElementById("main-table");
                var csv = [];
                var rows = table.querySelectorAll("tr");

                for (var i = 0; i < rows.length; i++) {
                    var row = [], cols = rows[i].querySelectorAll("td, th");

                    for (var j = 0; j < cols.length; j++) {
                        row.push(cols[j].innerText);
                    }

                    csv.push(row.join(","));
                }

                var csvString = csv.join("\n");
                var blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });

                if (navigator.msSaveBlob) { // IE 10+
                    navigator.msSaveBlob(blob, "main-table.csv");
                } else {
                    var link = document.createElement("a");
                    if (link.download !== undefined) {
                        var url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", "main-table.csv");
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                }
            }
        </script>
        
        <div>
            <button id="toggle-main-view">Switch Axes</button>
        </div>
        <div id="chart-container"></div>
        
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var chartData = {{ chart_data|safe }};
                var currentView = 'category'; // Initialize the current view to 'category'
        
                function updateMainChart() {
                    var categories = chartData.categories;
                    var series = chartData.series;
        
                    var seriesData;
        
                    if (currentView === 'category') {
                        seriesData = series;
                    } else {
                        seriesData = categories.map(function(category, index) {
                            var categoryData = series.map(function(serie) {
                                return serie.data[index];
                            });
        
                            return {
                                name: category,
                                data: categoryData
                            };
                        });
                    }
        
                    var chartOptions = {
                        chart: {
                            type: 'bar'
                        },
                        title: {
                            text: '{{ table_title }}'
                        },
                        xAxis: {
                            categories: currentView === 'category' ? categories : series.map(function(serie) {
                                return serie.name;
                            })
                        },
                        yAxis: {
                            min: 0,
                            title: {
                                text: 'Value'
                            }
                        },
                        legend: {
                            reversed: true
                        },
                        plotOptions: {
                            series: {
                                stacking: 'normal'
                            }
                        },
                        series: seriesData
                    };
        
                    Highcharts.chart('chart-container', chartOptions);
                }
        
                updateMainChart();
        
                document.getElementById('toggle-main-view').addEventListener('click', function() {
                    currentView = currentView === 'category' ? 'series' : 'category';
                    updateMainChart();
                });
            });
        </script>
        
        <div class="map-container">
            {% for path, title in paths_titles %}
                <div style="margin-bottom: 20px;">
                    <h2>{{ title }}</h2>
                    <div class="iframe-wrapper">
                        {% include path %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <style>
            .iframe-wrapper {
                width: 50%;
                height: 350px;
                border: 1px solid #ccc;
                padding: 10px;
                box-sizing: border-box;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>


        <div class="subtable" id="table">
            <h3>Table and Visualization for Subgroups By Year</h3>
            <text> * Please select a specific year and press submit to view the data table and visualization *</text>
            <form id="subgroup-form">
                {{ subgroup_form.as_p }}
                <input type="submit" value="Get Data and Visualization">
            </form>
            <table class="table2" border="1">
                <caption id="subtable-year"></caption>
                <thead>
                    <tr id="subtable-headers"></tr>
                </thead>
                <tbody id="subtable-rows"></tbody>
            </table>
        </div>
            <div>
                <button id="toggle-view">Switch Axes</button>
            </div>
            <div id="subtable-chart-container"></div>


        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script>
            $(document).ready(function() {
                var multiYearSubtableField = {{ multi_year_subtable_field|safe }};
                var subgroupChartData = {{ subgroup_chart_data|safe }};
                var currentView = 'tract'; // Initialize the current view to 'tract'

                function updateSubgroupTable(year) {
                    var subtableData = multiYearSubtableField[year];
                    $('#subtable-year').text(year);
                    $('#subtable-headers').empty();
                    $('#subtable-rows').empty();

                    subtableData.headers.forEach(function(header) {
                        $('#subtable-headers').append('<th>' + header + '</th>');
                    });

                    subtableData.rows.forEach(function(row) {
                        var rowHtml = '<tr>';
                        row.forEach(function(value) {
                            rowHtml += '<td>' + value + '</td>';
                        });
                        rowHtml += '</tr>';
                        $('#subtable-rows').append(rowHtml);
                    });

                    // Update the subtable chart based on the current view
                    updateChart(year, subtableData);
                }

                function updateChart(year, subtableData) {
                    var tractCategories = subtableData.rows.map(function(row) {
                        return row[0];
                    });

                    var raceGroups = subtableData.headers.slice(1);

                    var seriesData;

                    if (currentView === 'tract') {
                        seriesData = raceGroups.map(function(raceGroup, index) {
                            return {
                                name: raceGroup,
                                data: subtableData.rows.map(function(row) {
                                    return parseFloat(row[index + 1]) || null;
                                })
                            };
                        });
                    } else {
                        seriesData = tractCategories.map(function(tract, index) {
                            var tractData = subtableData.rows[index].slice(1).map(function(value) {
                                return parseFloat(value) || null;
                            });

                            return {
                                name: tract,
                                data: tractData
                            };
                        });
                    }

                    var chartOptions = {
                        chart: {
                            type: 'column'
                        },
                        title: {
                            text: 'Subgroup Data for ' + year
                        },
                        xAxis: {
                            categories: currentView === 'tract' ? tractCategories : raceGroups
                        },
                        yAxis: {
                            min: 0,
                            title: {
                                text: 'Value'
                            },
                            stackLabels: {
                                enabled: true,
                                style: {
                                    fontWeight: 'bold',
                                    color: ( // theme
                                        Highcharts.defaultOptions.title.style &&
                                        Highcharts.defaultOptions.title.style.color
                                    ) || 'gray'
                                }
                            }
                        },
                        legend: {
                            align: 'right',
                            x: -30,
                            verticalAlign: 'top',
                            y: 25,
                            floating: true,
                            backgroundColor:
                                Highcharts.defaultOptions.legend.backgroundColor || 'white',
                            borderColor: '#CCC',
                            borderWidth: 1,
                            shadow: false
                        },
                        tooltip: {
                            headerFormat: '<b>{point.x}</b><br/>',
                            pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
                        },
                        plotOptions: {
                            column: {
                                stacking: 'normal',
                                dataLabels: {
                                    enabled: true
                                }
                            }
                        },
                        series: seriesData
                    };

                    Highcharts.chart('subtable-chart-container', chartOptions);
                }

                $('#subgroup-form').submit(function(event) {
                    event.preventDefault();
                    var selectedYear = $('#id_subgroup_year').val();
                    updateSubgroupTable(selectedYear);
                });

                $('#toggle-view').click(function() {
                    currentView = currentView === 'tract' ? 'raceGroup' : 'tract';
                    var selectedYear = $('#id_subgroup_year').val();
                    var subtableData = multiYearSubtableField[selectedYear];
                    updateChart(selectedYear, subtableData);
                });

                var initialYear = '{{ subgroup_form.subgroup_year.value }}';
                updateSubgroupTable(initialYear);
            });
        </script>
    </body>
</html>
